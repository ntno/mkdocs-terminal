name: Test Package

on: 
  pull_request:
    types: [ synchronize ]

jobs:
  test:
    strategy:
      matrix:
        # python: ['3.7']
        # platform: ['ubuntu-latest']
        python: ['3.7', '3.8', '3.9', '3.10']
        platform: [ubuntu-latest, windows-latest] #, macos-latest,]
        include:
          - os: windows-latest
            scoop-install: true
          - os: ubuntu-latest
            apt-install: true
          - os: mac-latest
            brew-install: true
    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Python ${{ matrix.python }}
        uses: actions/setup-python@v3
        with:
          python-version: ${{ matrix.python }}
      - if: ${{ matrix.scoop-install }}
        name: Install test requirements (windows)
        run: |
          # iwr -useb get.scoop.sh | iex
          # scoop install tidy
          irm get.scoop.sh -outfile 'install.ps1'
          iex "& {$(irm get.scoop.sh)} -RunAsAdmin install tidy"
      - if: ${{ matrix.apt-install}}
        name: Install test requirements (ubuntu)
        run: |
          make USE_SUDO=1 install-dev-requirements
      - name: Install tox
        run: make install-tox
      - name: Test
        run: python -m tox -e py

  test-windows:
    strategy:
      matrix:
        python: ['3.7', '3.8', '3.9', '3.10']
        platform: [windows-latest] 
        include:
          - os: windows-latest
            scoop: true
    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Python ${{ matrix.python }}
        uses: actions/setup-python@v3
        with:
          python-version: ${{ matrix.python }}
      - if: ${{ matrix.scoop }}
        name: Install test requirements
        run: |
          # iwr -useb get.scoop.sh | iex
          # scoop install tidy
          irm get.scoop.sh -outfile 'install.ps1'
          iex "& {$(irm get.scoop.sh)} -RunAsAdmin install tidy"
      - name: Install tox
        run: make install-tox
      - name: Test
        run: python -m tox -e py

  # test-windows:
  #   strategy:
  #     matrix:
  #       python: ['3.8']
  #       platform: [windows-latest]
  #       include:
  #         - os: windows-latest
  #           scoop: true
  #     runs-on: ${{ matrix.platform }}
  #     steps:
  #       - name: Checkout
  #         uses: actions/checkout@v3
  #       # - name: Set up Python ${{ matrix.python }}
  #       #   uses: actions/setup-python@v3
  #       #   with:
  #       #     python-version: ${{ matrix.python }}
  #       - if: ${{ matrix.scoop }}
  #         name: Install test requirements
  #         run: |
  #           iwr -useb get.scoop.sh | iex
  #           scoop install tidy
        