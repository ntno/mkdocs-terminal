{%- import 'macros/side-nav/side-nav-item-class.j2' as class_helper with context -%}
{%- import 'macros/side-nav/side-nav-item.j2' as item_helper with context -%}
{%- import 'macros/side-nav/section-index-page-title.j2' as index_helper with context -%}
{%- import 'macros/side-nav/max-nesting.j2' as nesting_helper with context -%}

{% macro side_nav_item( nav_item ) -%}
    {% set macro_ns = namespace(class="") %}
    {% set macro_ns.class = class_helper.get_class( nav_item ) -%}
    {% if "navigation.side.indexes" in features and nav_item.title == index_helper.get_section_index_page_title() %}
        {{ item_helper.index_item( nav_item, macro_ns.class ) }}
    {% else %}
        {{ item_helper.non_index_item( nav_item, macro_ns.class ) }}
    {% endif %}
{%- endmacro -%}

{% macro nested_folder( nav_items, nesting_level ) -%}
   {% if nesting_level <= nesting_helper.get_max_nesting()|int %}
    <ul class="terminal-mkdocs-side-nav-li-ul">
        {% for nav_item in nav_items %}
            {% set found_index = false %}
            {% if "navigation.side.indexes" in features %}
                {% set index_matches = nav_item.children|selectattr("title", "eq", index_helper.get_section_index_page_title())|list %}
                {% if index_matches|length > 0 %}
                    {% set found_index = true %}
                {% endif %}
            {% endif %}

            <li class="terminal-mkdocs-side-nav-li-ul-li">
                {% if found_index %}
                    {{ side_nav_item( nav_item.children|selectattr("title", "eq", index_helper.get_section_index_page_title())|list|first ) }}
                {% else %}
                    {{ side_nav_item( nav_item ) }}
                {% endif %}

                {# Add recursive nesting for deeper levels #}
                {% if nav_item.children %}
                    {% if found_index %}
                        {{ nested_folder( nav_item.children|rejectattr("title", "eq", index_helper.get_section_index_page_title())|list , nesting_level+1 ) }}
                    {% else %}
                        {{ nested_folder( nav_item.children , nesting_level+1 ) }}
                    {% endif %}
                {% endif %}
            </li>
        {% endfor %}
    </ul>
    {%endif%}
{%- endmacro -%}

        <li class="terminal-mkdocs-side-nav-li">
    {% if nav_item.children %}
        {% set ns = namespace(index_matches=[], found_index=false) %}
        {% if "navigation.side.indexes" in features %}
            {% set ns.index_matches = nav_item.children|selectattr("title", "eq", index_helper.get_section_index_page_title())|list %}
            {% if ns.index_matches|length > 0 %}
                {% set ns.found_index = true %}
            {% endif %}    
        {% endif %}

        {% if nesting_helper.get_max_nesting()|int >= 1 %}
        {% if "navigation.side.indexes" in features and ns.found_index %}     
            {{ side_nav_item(ns.index_matches[0]) }}
        {% else %}
            {{ side_nav_item( nav_item ) }}
        {% endif %}
        {% endif %}
      
        {% if "navigation.side.indexes" in features and ns.found_index %}
            {{ nested_folder( nav_item.children|rejectattr("title", "eq", index_helper.get_section_index_page_title())|list , 2 ) }}
        {% else %}
            {{ nested_folder( nav_item.children , 2 ) }}
        {% endif %}
    {% else %}
    {{ side_nav_item( nav_item ) }}
    {% endif %}
       </li>
