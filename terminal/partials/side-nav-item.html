{% set partial_ns = namespace(section_class="terminal-mkdocs-side-nav-section", no_index_class="terminal-mkdocs-side-nav-section-no-index", active_class="terminal-mkdocs-side-nav-item--active", inactive_class="terminal-mkdocs-side-nav-item") %}

{% macro get_class( nav_item ) -%}
    {% set macro_ns = namespace(class="", index_has_active_sibling=false) %}
    {% if "navigation.side.indexes" in features and nav_item.title == "section-index" and nav_item.parent.children %}
        {% for sibling in nav_item.parent.children %}
            {% if sibling.active %}
                {% set macro_ns.index_has_active_sibling = true %}
            {% endif %}
        {% endfor %}
    {% endif%}

    {% if nav_item.active %}
        {% set macro_ns.class = partial_ns.active_class %}
    {% elif macro_ns.index_has_active_sibling %}
        {% set macro_ns.class = partial_ns.active_class %}
    {% else %}
        {% set macro_ns.class = partial_ns.inactive_class %}
    {% endif %}

    {{ macro_ns.class }}
{%- endmacro %}




{% macro side_nav_item( nav_item ) -%}
    {% set macro_ns = namespace(class="") %}
    {% set macro_ns.class = get_class( nav_item ) %}

    {% if "navigation.side.indexes" in features and nav_item.title == "section-index" %}
        {% if nav_item.active %}
            <span {% if macro_ns.class %}class="{{ macro_ns.class }}"{% endif %}>{{ nav_item.parent.title }}</span>
        {% else %}
            <a {% if macro_ns.class %}class="{{ macro_ns.class }}"{% endif %} href="{{ nav_item.url|url }}">{{ nav_item.parent.title }}</a>
        {% endif %}
    {% else %}
        {% if nav_item.active %}
            <span {% if macro_ns.class %}class="{{ macro_ns.class }}"{% endif %}>{{ nav_item.title }}</span>
        {% else %}
            <a {% if macro_ns.class %}class="{{ macro_ns.class }}"{% endif %} href="{{ nav_item.url|url }}">{{ nav_item.title }}</a>
        {% endif %}
    {% endif %}
{%- endmacro %}

<li class="terminal-mkdocs-side-nav-li">
    {% if nav_item.children %}
    
        {% set ns = namespace(index_matches=[], found_index=false) %}
        {% if "navigation.side.indexes" in features %}
            {% set ns.index_matches = nav_item.children|selectattr("title", "eq", "section-index")|list %}
            {% if ns.index_matches|length > 0 %}
                {% set ns.found_index = true %}
            {% endif %}    
        {% endif %}

        {% if "navigation.side.indexes" in features and ns.found_index %}     
            {{ side_nav_item(ns.index_matches[0]) }}
        {% else %}
            {{ side_nav_item( nav_item ) }}
        {% endif %}
      
        {% if "navigation.side.indexes" in features and ns.found_index %}
            {% for second_level in nav_item.children|rejectattr("title", "eq", "section-index")|list %}
            <ul class="terminal-mkdocs-side-nav-li-ul">
                <li class="terminal-mkdocs-side-nav-li-ul-li">{{ side_nav_item(second_level) }}</li>
            </ul>
            {% endfor %}
        {% else %}
            {% for second_level in nav_item.children %}
            <ul class="terminal-mkdocs-side-nav-li-ul">
                <li class="terminal-mkdocs-side-nav-li-ul-li">{{ side_nav_item(second_level) }}</li>
            </ul>
            {% endfor %}
        {% endif %}
    {% else %}
    {{ side_nav_item( nav_item ) }}
    {% endif %}
  </li>