{% set partial_ns = namespace(section_class="terminal-mkdocs-side-nav-section", active_class="terminal-mkdocs-side-nav-item--active", inactive_class="terminal-mkdocs-side-nav-item") %}

{% macro span_or_link( nav_item ) -%}
    {% if nav_item.active %}
        {% set item_class = partial_ns.active_class %}
    {% else %}
        {% set item_class = partial_ns.inactive_class %}
    {% endif %}

    {% if nav_item.active %}
        <span {% if item_class %}class="{{ item_class }}"{% endif %}>{{ nav_item.title }}</span>
    {% else %}
        <a {% if item_class %}class="{{ item_class }}"{% endif %} href="{{ nav_item.url|url }}">{{ nav_item.title }}</a>
    {% endif %}
{%- endmacro %}

{% macro section_span_or_index_link( nav_item ) -%}
    {% set section_ns = namespace(item_class="") %}
    {% set section_ns.item_class = partial_ns.section_class %}
    {% if nav_item.active %}
        {% set section_ns.item_class = section_ns.item_class ~ " " %}
        {% set section_ns.item_class = section_ns.item_class ~ partial_ns.active_class %}
    {% else %}
        {% set section_ns.item_class = section_ns.item_class ~ " " %}
        {% set section_ns.item_class = section_ns.item_class ~ partial_ns.inactive_class %}
    {% endif %}

    {% if nav_item.parent.children %}
        {% for sibling in nav_item.parent.children %}
            {% if sibling.active %}
                {% set section_ns.item_class = section_ns.item_class ~ " " %}
                {% set section_ns.item_class = section_ns.item_class ~ partial_ns.active_class %}
            {% endif %}
        {% endfor %}
    {% endif %}


    {% if nav_item.active %}
        <span {% if section_ns.item_class %}class="{{ section_ns.item_class }}"{% endif %}>{{ nav_item.parent.title }}</span>
    {% else %}
        <a {% if section_ns.item_class %}class="{{ section_ns.item_class }}"{% endif %} href="{{ nav_item.url|url }}">{{ nav_item.parent.title }}</a>
    {% endif %}
{%- endmacro %}

{% macro section_span_no_index( nav_item ) -%}
    {% set item_class = partial_ns.section_class %}
    {% if nav_item.active %}
        {% set item_class = item_class ~ " " %}
        {% set item_class = item_class ~ partial_ns.active_class %}
    {% else %}
        {% set item_class = item_class ~ " " %}
        {% set item_class = item_class ~ partial_ns.inactive_class %}
    {% endif %}
    <span {% if item_class %}class="{{ item_class }}"{% endif %}>{{ nav_item.title }}</span>
{%- endmacro %}
   

<li class="terminal-mkdocs-side-nav-li">
    {% if nav_item.children %}
    
        {% set ns = namespace(index_matches=[], found_index=false) %}
        {% if "navigation.side.indexes" in features %}
            {% set ns.index_matches = nav_item.children|selectattr("title", "eq", "section-index")|list %}
            {% if ns.index_matches|length > 0 %}
                {% set ns.found_index = true %}
            {% endif %}    
        {% endif %}

        {% if "navigation.side.indexes" in features and ns.found_index %}     
            {{ section_span_or_index_link(ns.index_matches[0]) }}
        {% else %}
            {{ section_span_no_index( nav_item ) }}
        {% endif %}
      
        {% if "navigation.side.indexes" in features and ns.found_index %}
            {% for second_level in nav_item.children[1:] %}
            <ul class="terminal-mkdocs-side-nav-li-ul">
                <li class="terminal-mkdocs-side-nav-li-ul-li">{{ span_or_link(second_level) }}</li>
            </ul>
            {% endfor %}
        {% else %}
            {% for second_level in nav_item.children %}
            <ul class="terminal-mkdocs-side-nav-li-ul">
                <li class="terminal-mkdocs-side-nav-li-ul-li">{{ span_or_link(second_level) }}</li>
            </ul>
            {% endfor %}
        {% endif %}
    {% else %}
    {{ span_or_link( nav_item ) }}
    {% endif %}
  </li>