{% macro link_or_span(nav_item, title_override) -%}
    {% if nav_item.active %}
        <span><i>
          {% if title_override %}
          {{ nav_item.parent.title }}
          {% else %}
          {{ nav_item.title }}
          {% endif %}
        </i></span>
    {% else %}
        <a href="{{ nav_item.url|url }}">
          {% if title_override %}
          {{ nav_item.parent.title }}
          {% else %}
          {{ nav_item.title }}
          {% endif %}
        </a>
    {% endif %}
{%- endmacro %}

{% macro span(nav_item) -%}
    {% if nav_item.active %}
        <span class="active"><i>{{ nav_item.title }}</i></span>
    {% else %}
        <span>{{ nav_item.title }}</span>
    {% endif %}
{%- endmacro %}

{% macro level_two_link_or_span(nav_item) -%}
    {% if nav_item.active %}
    <span class="side-panel-highlight"><i>{{ nav_item.title }}</i></span>
    {% else %}
    <a href="{{ nav_item.url|url }}">{{ nav_item.title }}</a>
    {% endif %}
{%- endmacro %}

{% macro render(nav_item, path, level) %}

  <li class="terminal-side-panel-level-{{ level }}">
    {% if nav_item.children %}
    
      {% if "navigation.indexes" in features %}
          <!-- navigation.indexes feature is ON -->
          <!-- determine if section has an index -->
          {% set ns = namespace(index_matches=[]) %}
          {% set ns.index_matches = nav_item.children|selectattr("title", "eq", "section-index")|list %}

          <!-- section has an index -->
          {% if ns.index_matches|length > 0 %}
          {{ link_or_span(ns.index_matches[0], true) }}
          <!-- TODO - set some flag to skip index page in children listing -->

          <!-- section does NOT have an index -->
          {% else %}
          {{ span( nav_item ) }}
          {% endif %}
      {% else %}
          <!-- navigation.indexes feature is OFF -->
          <!-- TODO better styling --- grey? -->
          {{ span( nav_item ) }}
      {% endif %}
      
      <!-- section items -->
      {% for second_level in nav_item.children %}
      <ul>
          <li>{{ level_two_link_or_span(second_level) }}</li>
      </ul>
      {% endfor %}
    {% else %}
    <!-- link for a top level page -->
    {{ link_or_span(nav_item) }}
    {% endif %}
  </li>

  

{% endmacro %}
{{ render(nav_item, path, level) }}
      