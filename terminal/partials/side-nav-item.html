{% set partial_ns = namespace(no_section_index_available_class="terminal-mkdocs-side-nav-item-section-no-index", active_class="terminal-mkdocs-side-nav-item--active") %}

{% macro span_or_link( nav_item ) -%}
    {% if nav_item.active %}
        {% set item_class = partial_ns.active_class %}
    {% endif %}

    {% if nav_item.active %}
        <span {% if item_class %}class="{{ item_class }}"{% endif %}>{{ nav_item.title }}</span>
    {% else %}
        <a  {% if item_class %}class="{{ item_class }}"{% endif %} href="{{ nav_item.url|url }}">{{ nav_item.title }}</a>
    {% endif %}
{%- endmacro %}

{% macro section_span_or_index_link( nav_item ) -%}
    {% if nav_item.active %}
        {% set item_class = partial_ns.active_class %}
    {% endif %}

    {% if nav_item.active %}
        <span {% if item_class %}class="{{ item_class }}"{% endif %}>{{ nav_item.parent.title }}</span>
    {% else %}
        <a  {% if item_class %}class="{{ item_class }}"{% endif %} href="{{ nav_item.url|url }}">{{ nav_item.parent.title }}</a>
    {% endif %}
{%- endmacro %}

{% macro section_span_no_index( nav_item ) -%}
    {% set item_class = partial_ns.no_section_index_available_class %}
    {% if nav_item.active %}
        {% set item_class = item_class ~ " " %}
        {% set item_class = item_class ~ partial_ns.active_class %}
    {% endif %}
    <span {% if item_class %}class="{{ item_class }}"{% endif %}>{{ nav_item.title }}</span>
{%- endmacro %}

<li class="terminal-mkdocs-side-nav-li">
    {% if nav_item.children %}
    
      {% if "navigation.side.indexes" in features %}
          <!-- navigation.side.indexes feature is ON -->
          <!-- determine if section has an index -->
          {% set ns = namespace(index_matches=[]) %}
          {% set ns.index_matches = nav_item.children|selectattr("title", "eq", "section-index")|list %}

          <!-- section has an index -->
          {% if ns.index_matches|length > 0 %}
          {{ section_span_or_index_link(ns.index_matches[0]) }}
          <!-- TODO - set some flag to skip index page in children listing -->

          <!-- section does NOT have an index -->
          {% else %}
          {{ section_span_no_index( nav_item ) }}
          {% endif %}
      {% else %}
          <!-- navigation.side.indexes feature is OFF -->
          <!-- TODO better styling --- grey? -->
          {{ section_span_no_index( nav_item ) }}
      {% endif %}
      
      <!-- section items -->
      {% for second_level in nav_item.children %}
      <ul class="terminal-mkdocs-side-nav-li-ul">
          <li class="terminal-mkdocs-side-nav-li-ul-li">{{ span_or_link(second_level) }}</li>
      </ul>
      {% endfor %}
    {% else %}
    <!-- link for a top level page -->
    {{ span_or_link( nav_item ) }}
    {% endif %}
  </li>